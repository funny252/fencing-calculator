var map;
var geocoder;

var panelTools = false;
var multiMode = false;

var draglat = 0;
var draglng = 0;

var selectedBox = null;
var selectedBoxList = new Array(0);
var points = new Array(0);
var singles = new Array(0);
var areacontainer = new Array(0);
var areacontainer_current;
var boxSet = new Array(0);
var areaPath = new Array(0);
var areaPath2 = new Array(0);
var polygon = new Array(0);
var areaMarkers = new Array(0);
var areaAnchors = new Array(0);
var areaRotators = new Array(0);
var rotatorLines = new Array(0);
var lineColor = '#9BB653';
var fillColor = '#00ff00';
var lineWidth = 5;
var lineOpacity = 1.0;
var fillOpacity = 0.2;
var radiansPerDegree = Math.PI / 180.0;
var degreesPerRadian = 180.0 / Math.PI;
var earthRadiusMeters = 6367460.0;
var metersPerDegree = 2.0 * Math.PI * earthRadiusMeters / 360.0;
var metersPerKm = 1000.0;
var meters2PerHectare = 10000.0;
var feetPerMeter = 3.2808399;
var feetPerMile = 5280.0;
var acresPerMile2 = 640;
var totalarea = 0;
var readonly = false;
var overlay;
var projection;
var polygon_context_menu;
var marker_index_context_menu;
var marker_number_context_menu;
var polyline_index_context_menu;
var polyline_number_context_menu;
var readonly_ran = false;
var areacontainer_labels = new Array(0);
var areacontainer_types = new Array(0);
var areacontainer_toggle = new Array(0);
var search_marker = null;




function MapLabel(opt_options) {
  this.set('fontFamily', 'sans-serif');
  this.set('fontSize', 12);
  this.set('fontColor', '#000000');
  this.set('strokeWeight', 4);
  this.set('strokeColor', '#ffffff');
  this.set('align', 'center');

  this.set('zIndex', 1e3);

  this.setValues(opt_options);
}
MapLabel.prototype = new google.maps.OverlayView;

window['MapLabel'] = MapLabel;


/** @inheritDoc */
MapLabel.prototype.changed = function(prop) {
  switch (prop) {
    case 'fontFamily':
    case 'fontSize':
    case 'fontColor':
    case 'strokeWeight':
    case 'strokeColor':
    case 'align':
    case 'text':
      return this.drawCanvas_();
    case 'maxZoom':
    case 'minZoom':
    case 'position':
      return this.draw();
  }
};

/**
 * Draws the label to the canvas 2d context.
 * @private
 */
MapLabel.prototype.drawCanvas_ = function() {
  var canvas = this.canvas_;
  if (!canvas) return;

  var style = canvas.style;
  style.zIndex = /** @type number */(this.get('zIndex'));

  var ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.strokeStyle = this.get('strokeColor');
  ctx.fillStyle = this.get('fontColor');
  ctx.font = this.get('fontSize') + 'px ' + this.get('fontFamily');

  var strokeWeight = Number(this.get('strokeWeight'));

  var text = this.get('text');
  if (text) {
    if (strokeWeight) {
      ctx.lineWidth = strokeWeight;
      ctx.strokeText(text, strokeWeight, strokeWeight);
    }

    ctx.fillText(text, strokeWeight, strokeWeight);

    var textMeasure = ctx.measureText(text);
    var textWidth = textMeasure.width + strokeWeight;
    style.marginLeft = this.getMarginLeft_(textWidth) + 'px';
    // Bring actual text top in line with desired latitude.
    // Cheaper than calculating height of text.
    style.marginTop = '-0.4em';
  }
};

/**
 * @inheritDoc
 */
MapLabel.prototype.onAdd = function() {
  var canvas = this.canvas_ = document.createElement('canvas');
  var style = canvas.style;
  style.position = 'absolute';

  var ctx = canvas.getContext('2d');
  ctx.lineJoin = 'round';
  ctx.textBaseline = 'top';

  this.drawCanvas_();

  var panes = this.getPanes();
  if (panes) {
    panes.mapPane.appendChild(canvas);
	//panes.floatPane.appendChild(canvas);
  }
};
MapLabel.prototype['onAdd'] = MapLabel.prototype.onAdd;

/**
 * Gets the appropriate margin-left for the canvas.
 * @private
 * @param {number} textWidth  the width of the text, in pixels.
 * @return {number} the margin-left, in pixels.
 */
MapLabel.prototype.getMarginLeft_ = function(textWidth) {
  switch (this.get('align')) {
    case 'left':
      return 0;
    case 'right':
      return -textWidth;
  }
  return textWidth / -2;
};

/**
 * @inheritDoc
 */
MapLabel.prototype.draw = function() {
  var projection = this.getProjection();

  if (!projection) {
    // The map projection is not ready yet so do nothing
    return;
  }

  if (!this.canvas_) {
    // onAdd has not been called yet.
    return;
  }

  var latLng = /** @type {google.maps.LatLng} */ (this.get('position'));
  if (!latLng) {
    return;
  }
  var pos = projection.fromLatLngToDivPixel(latLng);

  var style = this.canvas_.style;

  style['top'] = pos.y + 'px';
  style['left'] = pos.x + 'px';

  style['visibility'] = this.getVisible_();
};
MapLabel.prototype['draw'] = MapLabel.prototype.draw;

/**
 * Get the visibility of the label.
 * @private
 * @return {string} blank string if visible, 'hidden' if invisible.
 */
MapLabel.prototype.getVisible_ = function() {
  var minZoom = /** @type number */(this.get('minZoom'));
  var maxZoom = /** @type number */(this.get('maxZoom'));

  if (minZoom === undefined && maxZoom === undefined) {
    return '';
  }

  var map = this.getMap();
  if (!map) {
    return '';
  }

  var mapZoom = map.getZoom();
  if (mapZoom < minZoom || mapZoom > maxZoom) {
    return 'hidden';
  }
  return '';
};

/**
 * @inheritDoc
 */
MapLabel.prototype.onRemove = function() {
  var canvas = this.canvas_;
  if (canvas && canvas.parentNode) {
    canvas.parentNode.removeChild(canvas);
  }
};
MapLabel.prototype['onRemove'] = MapLabel.prototype.onRemove;

$(document).ready(function(){
	
	//if(id!='')
		//$("#slideout-menu").hide();
	
	$( "#tabs" ).tabs();
	
	$("button").button();
	
	$("#delete-dialog, #delete-all-dialog, #save-dialog, #shape-dialog, #rotate-dialog, #instructions-dialog, #file-dialog, #setAreaLabel-dialog, #setLineLength-dialog").dialog({
		autoOpen: false, 
		modal: true, 
		resizable:false,
		open: function(event, ui){
			$(window).trigger('resize');
		},
		close: function(event, ui){
			$(window).trigger('resize');
		}
	});
	
	$("#type").change(function(){
		$(".shape").hide();
		var type = $("#type").val();
		$("#"+type).show();
	}).trigger('change');
	
	$(".shape input").val('');
	
	$(".shape input").numeric({ negative: false });
	
	$("#rotate-dialog input").numeric({negative: false});
	
	
	
	initialize_map();
	
	initializePanelMenu();
	initializePolygonMenu();
	initializeMarkerMenu();
	initializePolylineMenu();
	initializeSearchMarkerMenu();
	
	
//	$("#address").val('');
		  var dataConv = null;
	
	
	$("#address").autocomplete({
	
	      source: function(request, response) {	    	                            
  	        geocoder.geocode( {'address': request.term }, function(results, status) {
  	        	if(results != null){
  	        		dataConv = $.map(results, function(item) {
  		            return {
  		            	id: '',
  		              label:  item.formatted_address,
  		              value: item.formatted_address,
  		              latitude: item.geometry.location.lat(),
  		              longitude: item.geometry.location.lng(),
  		              southwest: item.geometry.viewport.getSouthWest(),
  		              northeast: item.geometry.viewport.getNorthEast()  		              					  							              
  		              
  		            }
  		          });
  	        	}  	        	
				
				if ( dataConv != null )
					response(dataConv);
  		        //set_dimensions();
          });	    	  
      	        
	      },
	      //This bit is executed upon selection of an address
	      select: function(event, ui) {
	        var location = new google.maps.LatLng(ui.item.latitude, ui.item.longitude);
	        map.setZoom(20);
	        map.setCenter(location);
	        
	        var resultBounds = new google.maps.LatLngBounds(
	        		ui.item.southwest, 
	        		ui.item.northeast
				);

				map.fitBounds(resultBounds);

				placeSearchMarker(location);
	        
	      }
	   	});

	$("#calculations, #totals").hide();
	
	if(id!=''){
		readonly = true;
		//setReadonly(id);
	}
	
	set_dimensions();
	
	$(window).resize(function() {
		set_dimensions();
	});
	
		
	set_dimensions();
	////$(window).trigger('resize');
	
	$("#arrow").click(function(){
		
		var cls = $("#slideout-menu").attr('class');
				
		if(cls=="out"){
			$("#slideout-menu").removeClass("out");
			var left = '-=422';
			$(this).button({
				label: '<br>><br><br>'
			});
			
		}else{
			$("#slideout-menu").addClass("out");
			var left = '+=422';
			$(this).button({
				label: '<br><<br><br>'
			});
		}
		
		$("#slideout-menu").animate({
			left: left,
		});
	});
	
	$( "#radio" ).buttonset();
	
	$("#radio").change(function(){
		var value = $(this).find('input:checked').val();
		set_toggle(value);
	});
	
});



google.maps.Polygon.prototype.my_getBounds=function(){
    var bounds = new google.maps.LatLngBounds()
    this.getPath().forEach(function(element,index){bounds.extend(element)})
    return bounds
}
function set_toggle(value){
	areacontainer_toggle[areacontainer_current] = value;
	display();
}


function updateOritentation()
{
	var f = document.getElementById('roof_orientation').value == 'landscape';
	document.getElementById('flipPanels').checked = f;
}
function set_dimensions(){
	
	var fullwidth = $(window).width();
	//var fullwidth = $('body').width();
	//var fullwidth = screen.availWidth;
	//var fullwidth = $('body').innerWidth();	
	var leftwidth = $("#left").width();	
	var rightwidth = fullwidth - leftwidth - 2;
	$("#right").css('width',rightwidth);
	//$("#right").width(rightwidth);
	
	var fullheight = $(window).height();
	$("#side-panel-content").css('height',fullheight - 42);
	
	if(areacontainer.length > 1){
		if(id!='')
			var calc_height = 400;
		else
			var calc_height = 480;
	}else{
		if(id!='')
			var calc_height = 190;
		else
			var calc_height = 270;
	}
		
	$("#calculations").css('height', fullheight - 42 - calc_height);
	
	//google.maps.event.trigger(map, 'resize');
	
	//console.log(fullwidth);
}

function guid() {
  function s4() {
    return Math.floor((1 + Math.random()) * 0x10000)
      .toString(16)
      .substring(1);
  }
  return s4() + s4() + '-' + s4() + '-' + s4() + '-' +
    s4() + '-' + s4() + s4() + s4();
}

function createPoint(lat, lng, pin)
{
//	console.log("Create point " + pinIcon );
	if ( pin === '' )
		return null;

	var pinIcon = null;
	if ( pin === 'gate' )
		pinIcon = basePath + 'img/gate.png';	
	else if ( pin === 'doublegate' )
		pinIcon = basePath + 'img/doublegate.png';	
	else
		pinIcon = pin;
		
	var icon = new google.maps.MarkerImage(pinIcon,
				new google.maps.Size(24, 20),
				new google.maps.Point(0,0),
				new google.maps.Point(7, 20)
			);
	var shadow = new google.maps.MarkerImage('img/pin-shadow.png',
		      // The shadow image is larger in the horizontal dimension
		      // while the position and offset are the same as for the main image.
		      new google.maps.Size(25, 25),
		      new google.maps.Point(0,0),
		      new google.maps.Point(4, 33));
	
	var myLatLng = {lat: lat, lng: lng };
	
	var uuid = guid();
	var marker = new google.maps.Marker({
        position: myLatLng,
        map: map,
        shadow: shadow,
        icon: icon,
		uuid: uuid,
        draggable: true
    });
	
	console.log("Marker " + pinIcon + " " + myLatLng );

	canvasMarkers.push( marker );	
 //   google.maps.event.addListener(marker, 'dragend', function(event){
//				url: '../../modules/crm/canvas_cmd.jsp?cmd=update_pos&lat=' + event.latLng.lat() + '&lng=' + event.latLng.lng() + '&uuid=' + marker.uuid,
//    	});
    	google.maps.event.addListener(marker, 'click', function(event){
    		//console.log("Click " + this + " " + this.uuid );
			if ( $('#deleteBox').hasClass('activeMenuActionD') )
			{
				marker.setMap(null);
				for ( var i = 0; i < canvasMarkers.length; ++i ) {				
					if ( canvasMarkers[i].uuid === marker.uuid) {
						canvasMarkers.splice(i, 1);
						break;
					}
				}
			}
			else if ( $('#setStyleBox').hasClass('activeMenuActionD') )
			{
				setGateStyle( marker.uuid );
			}
			//markerMenu(this, event);
			return false;
    	});
		
	//setGateStyle(uuid);	
		
}


function map_click(event){	

	if ( $('#doublegate').hasClass('activeMenuActionD') )
	{
		createPoint(event.latLng.lat(), event.latLng.lng(), 'doublegate' );
	}		
	else if ( $('#gate').hasClass('activeMenuActionD') )
	{
		createPoint(event.latLng.lat(), event.latLng.lng(), 'gate' );
	}			
	else if ( $('#otherSvg').hasClass('activeMenuActionZ') )
	{
		createPoint(event.latLng.lat(), event.latLng.lng(), subaction );
	}
	else if ( $('#drawSvg').hasClass('activeMenuActionZ') )
	{
		if(areacontainer_current == null){
			createNewArea()
		}
		areacontainer[areacontainer_current].push(event.latLng);
		activeLine = true;
		display();
		$(".context-menu").css('visibility','hidden');
	}
}


var totalFenceArea = 0;

function display(){
	
	clearMap();
	
	var total_perimeter_m = 0;
	var total_perimeter_ft = 0;
	var total_area_m = 0;
	var total_area_km = 0;
	var total_area_acres = 0;
	var total_area_hectares = 0;
	var total_area_ft = 0;
	var total_area_snm = 0;
	var total_perimeter_yard = 0;
	var total_area_yard = 0;
	
	totalFenceArea = 0;
	$("#calculations, #totals").hide();
	
	for ( var j = 0; j < mapLabels.length; ++j )
	{
		mapLabels[j].setMap(null);
	}
	mapLabels = [];
	
	for (var i = 0; i < areacontainer.length; i++){
		
		var tmp_arr = Array(0);
		
		$("#calculations, #totals").show();
		$("#instructions").hide();
		
		if(areacontainer_current == i){
        	var temp_fillColor = "#003461";
        	var temp_fillOpacity = '0.5';
        	var temp_lineColor = lineColor;
        }else{
        	var temp_fillColor = fillColor;
        	var temp_fillOpacity = fillOpacity;
        	var temp_lineColor = lineColor;
        }
		
		if(areacontainer_types[i] == 'SUB'){
			temp_lineColor = "red";
		}
		
		if(areacontainer[i].length==2){
			var distanceTooltip = getPolylineDistance(areacontainer[i]);
			//totalFenceLine += distanceTooltip;
		}
		else{
			var distanceTooltip = "";
		}
		
		var temp_areaPath = new google.maps.Polyline({
            path: areacontainer[i],
            strokeColor: temp_lineColor,
            strokeOpacity: lineOpacity,
            strokeWeight: lineWidth,
            geodesic: false,
            index: i,
            number: 0,
            distanceTooltip: distanceTooltip
        });
		temp_areaPath.setMap(map);
        //areaPath.push(temp_areaPath);
        
		
		if (areacontainer[i].length == 2) {
			
		 if(!(readonly)){
            google.maps.event.addListener(temp_areaPath, 'click', function(event){
            	areacontainer[this.index].splice(this.number + 1, 0, event.latLng);
            	display();
            });
            google.maps.event.addListener(temp_areaPath, 'rightclick', function(event){
            	polylineMenu(this,event);
            });		                        
         }
         
         google.maps.event.addListener(temp_areaPath, 'mouseover', function(event){
         	polylineHover(this, event.latLng);		            	
         });
         google.maps.event.addListener(temp_areaPath, 'mouseout', function(event){
         	$(".distanceTooltip").remove();		            	
         });
		}
         
         
         tmp_arr.push(temp_areaPath);
 		areaPath2.push(tmp_arr);
		
 		placeLabel(i);
        
        var perm = 1000 * temp_areaPath.inKm();
        var perimeter_m = perm.toFixed(3);
        var perimeter_ft = (perm * 3.2808399).toFixed(3);
        var perimeter_yard = (perimeter_m * 1.09361).toFixed(2);
        var area_m = 0;
        var area_km = 0;
        var area_acres = 0;
        var area_hectares = 0;
        var area_ft = 0;
        var area_snm = 0;
        var area_yard = 0;
        
        var dummy_polygon = new google.maps.Polygon({
            paths: Array(0),
            strokeColor: temp_lineColor,
            strokeOpacity: lineOpacity,
            strokeWeight: lineWidth,
            fillColor: temp_fillColor,
            geodesic: false,
            fillOpacity: temp_fillOpacity,
            clickable: false,
            index: i
        });
        polygon.push(dummy_polygon);		
        
        
        if (areacontainer[i].length > 2) {
        	
        	polygon.pop();
        	/*
        	if (areaPath2.length > 0) {
                for (q in areaPath2) {
                    for(w in areaPath2[q]){
                		areaPath2[q][w].setMap(null)
                	}
                }
            }
        	areaPath2 = Array(0);
        	*/
        	tmp_arr = Array(0);
        	
        	for(var k=0; k<areacontainer[i].length-1; k++){
        		
        		var arr = Array(0);
        		arr.push(areacontainer[i][k]);
        		arr.push(areacontainer[i][k+1]);
				
				var segmentLength = getPolylineDistance(arr);
        		
        		
	            var temp_areaPath2 = new google.maps.Polyline({
	                path: arr,
	                strokeColor: temp_lineColor,
	                strokeOpacity: lineOpacity,
	                strokeWeight: lineWidth,
	                geodesic: false,
	                fillOpacity: temp_fillOpacity,
	                index: i,
	                number: k,
	                distanceTooltip: segmentLength
	            });
	            
	            
	            
	            if(!(readonly)){
		            google.maps.event.addListener(temp_areaPath2, 'click', function(event){
		            	areacontainer[this.index].splice(this.number + 1, 0, event.latLng);
		            	display();
		            });
		            google.maps.event.addListener(temp_areaPath2, 'rightclick', function(event){
		            	polylineMenu(this,event);
		            });		                        
	            }
	            
	            google.maps.event.addListener(temp_areaPath2, 'mouseover', function(event){
	            	polylineHover(this, event.latLng);		            	
	            });
	            google.maps.event.addListener(temp_areaPath2, 'mouseout', function(event){
	            	$(".distanceTooltip").remove();		            	
	            });
	            
	            temp_areaPath2.setMap(map);
	            tmp_arr.push(temp_areaPath2);
	            
	            /**************************************************/
        	}
        	
        	areaPath2.push(tmp_arr);
        	
        	
        	/*
            var temp_polygon = new google.maps.Polygon({
                paths: areacontainer[i],
                strokeColor: temp_lineColor,
                strokeOpacity: lineOpacity,
                strokeWeight: lineWidth,
                fillColor: temp_fillColor,
                geodesic: false,
                fillOpacity: temp_fillOpacity,
                clickable: false,
                index: i
            });
            temp_polygon.setMap(map);
            polygon.push(temp_polygon);
		   
		    if ( areacontainer_toggle[areacontainer_current] != 'HIDE_BOTH' )
			{
				var marker2 = placeAnchor(getPolygonCenter(i), i);
				areaAnchors.push(marker2);
				//marker.setMap(map);
			}            
            placeLabel(i);
            
            if(!(readonly)){
	            var f = function (index) {
	                return function () {
	                	areacontainer_current = index;
	                    display();
	                    $(".context-menu").css('visibility','hidden');
	                }
	            };
	            google.maps.event.addListener(temp_polygon, 'click', map_click);
	            	            
	            google.maps.event.addListener(temp_polygon, 'rightclick', function(event){
	            	polygonMenu(this,event);	            	
	            });
	            	        
	            //var marker3 = placeRotator(getPolygonCenter(i), i);
	            //var marker3 = placeRotator(getPolygonCenter(polygon.length-1), polygon.length-1);
	            //areaRotators.push(marker3);
	            	            
	            
            }
           */
            
            var areaMeters2 = PlanarPolygonAreaMeters2(areacontainer[i]);
 
            var area_m = Areas(areaMeters2);
            var area_km = Areaskm(areaMeters2);
            var area_acres = Areasacre(areaMeters2);
            var area_hectares = Areashectare(areaMeters2);
            var area_ft = Areasfeet(areaMeters2);
            var area_snm = AreasNatMiles(areaMeters2);
            var area_yard = Areasyard(areaMeters2);
            
            
                                     
        }
        
        //displayCalculations(i, perimeter_m, perimeter_ft, area_m, area_km, area_acres, area_hectares, area_ft, area_snm, perimeter_yard, area_yard);
        

        if(areacontainer_types[i]=='ADD'){
	    	total_perimeter_m = total_perimeter_m + parseFloat(perimeter_m);
	    	total_perimeter_ft = total_perimeter_ft + parseFloat(perimeter_ft);
	    	total_perimeter_yard = total_perimeter_yard + parseFloat(perimeter_yard);
	    	total_area_m = total_area_m + parseFloat(area_m);
	    	total_area_km = total_area_km + parseFloat(area_km);
	    	total_area_acres = total_area_acres + parseFloat(area_acres);
	    	total_area_hectares = total_area_hectares + parseFloat(area_hectares);
	    	total_area_ft = total_area_ft + parseFloat(area_ft);
	    	total_area_snm = total_area_snm + parseFloat(area_snm);	
	    	total_area_yard = total_area_yard + parseFloat(area_yard);	
        }else{
        	//total_perimeter_m = total_perimeter_m - parseFloat(perimeter_m);
	    	//total_perimeter_ft = total_perimeter_ft - parseFloat(perimeter_ft);
	    	//total_perimeter_yard = total_perimeter_yard - parseFloat(perimeter_yard);
	    	total_area_m = total_area_m - parseFloat(area_m);
	    	total_area_km = total_area_km - parseFloat(area_km);
	    	total_area_acres = total_area_acres - parseFloat(area_acres);
	    	total_area_hectares = total_area_hectares - parseFloat(area_hectares);
	    	total_area_ft = total_area_ft - parseFloat(area_ft);
	    	total_area_snm = total_area_snm - parseFloat(area_snm);	
	    	total_area_yard = total_area_yard - parseFloat(area_yard);
        }

        
        for (var j = 0; j < areacontainer[i].length; j++) {
        	if(areacontainer_toggle[i]=='HIDE_LABELS' || areacontainer_toggle[i]=='HIDE_NONE' /*|| id!=''*/){
	           // var marker = placeMarker(areacontainer[i][j], j, i);
	            //areaMarkers.push(marker);
	            //marker.setMap(map);
        	}
        }
        
	}
	
	$('.fencePermiter').html( totalFenceArea.toFixed(2) + "'" );
	
	if(areacontainer.length != null && areacontainer.length > 1)
		displayCalculationTotals(total_perimeter_m, total_perimeter_ft, total_area_m, total_area_km, total_area_acres, total_area_hectares, total_area_ft, total_area_snm, total_perimeter_yard, total_area_yard)
		
	$("#calculations").accordion('destroy').accordion({
		header: '.title',
		active: areacontainer_current,
		autoHeight: false
	});
	$("#totals").accordion('destroy').accordion({
		header: '.title',
		active: 0,
		autoHeight: false
	});
	$("button").button();
	//$(window).trigger("resize");
	set_dimensions();
	
	$("#slideout-menu-overlay").html(areacontainer_labels[areacontainer_current]);
	
	$("#radio input").trigger('blur');
	/*
	if(areacontainer_toggle[areacontainer_current]=='HIDE_PINS'){
		$("#radio1").trigger('click');
	}else if(areacontainer_toggle[areacontainer_current]=='HIDE_LABELS'){
		$("#radio2").trigger('click');
	}else if(areacontainer_toggle[areacontainer_current]=='HIDE_BOTH'){
		$("#radio3").trigger('click');
	}else if(areacontainer_toggle[areacontainer_current]=='HIDE_NONE'){
		$("#radio4").trigger('click');
	}*/
	
}

function removeAllPanels() {
   if (boxSet.length > 0) {
        for ( var j = 0; j < boxSet.length; ++j) {
            if ( boxSet[j].length > 0 )
			{
				var boxes = boxSet[j];
				for ( var i = 0; i < boxes.length; ++i) {
				  boxes[i].setMap(null);
				  delete boxes[i];
				}
			}
        }
	}
	boxSet.length = 0;
}

function clearMap() {
    if (areaMarkers) {
        for (i in areaMarkers) {
            areaMarkers[i].setMap(null)
        }
    }
    if (areaPath.length > 0) {
        for (i in areaPath) {
            areaPath[i].setMap(null)
        }
    }

 
    if (areaPath2.length > 0) {
        for (i in areaPath2) {
            for(j in areaPath2[i]){
        		areaPath2[i][j].setMap(null)
        	}
        }
    }
    if (polygon.length > 0) {
        for (i in polygon) {
            polygon[i].setMap(null)
        }
    }
    if (areaAnchors.length > 0) {
        for (i in areaAnchors) {
        	areaAnchors[i].setMap(null)
        }
    }
    
    if (areaRotators.length > 0) {
        for (i in areaRotators) {
        	areaRotators[i].setMap(null)
        }
    }
    
    if (rotatorLines.length > 0) {
        for (i in rotatorLines) {
        	rotatorLines[i].setMap(null)
        }
    }
    
    areaMarkers = new Array(0);
    areaPath = new Array(0);
    areaPath2 = new Array(0);
    polygon = new Array(0);
    areaAnchors = new Array(0);
    areaRotators = new Array(0);
    rotatorLines = new Array(0);
    
    $('#calculations, #totals').html('');
    $("#instructions").show();
    $('.polygon-label').remove();
    $("#slideout-menu-overlay").html('');
}


function middlePoint(lat1, lng1, lat2, lng2) {
	
    //-- Longitude difference
    var dLng = (lng2 - lng1).toRad();

    //-- Convert to radians
    lat1 = lat1.toRad();
    lat2 = lat2.toRad();
    lng1 = lng1.toRad();

    var bX = Math.cos(lat2) * Math.cos(dLng);
    var bY = Math.cos(lat2) * Math.sin(dLng);
    var lat3 = Math.atan2(Math.sin(lat1) + Math.sin(lat2), Math.sqrt((Math.cos(lat1) + bX) * (Math.cos(lat1) + bX) + bY * bY));
    var lng3 = lng1 + Math.atan2(bY, Math.cos(lat1) + bX);

    //-- Return result
    return new google.maps.LatLng(lat3.toDeg(), lng3.toDeg());
}

var mapLabels = new Array();

function findHeading(heading) {
        var tmp = heading;
        if (tmp > 360) {
            tmp = heading - 360;
        } else if (tmp < 0) {
            tmp = heading + tmp;
        }
        return tmp;
    };


function getPolylineDistance(points){
	
	var dest_m = google.maps.geometry.spherical.computeDistanceBetween(new google.maps.LatLng(points[0].lat(), points[0].lng()), new google.maps.LatLng(points[1].lat(), points[1].lng() )); 	

    var dest_ft = (dest_m * 3.2808399).toFixed(2);
    var dest_yard = (dest_m * 1.09361).toFixed(2);

	totalFenceArea += parseFloat(dest_ft);

	var midPoint = middlePoint(points[0].lat(), points[0].lng(), points[1].lat(), points[1].lng());	

	var heading = findHeading(google.maps.geometry.spherical.computeHeading(points[0], points[1]));
	var tmpDist = 0.00005;

	var perpAngle = 90;
	heading = Math.abs( heading );
	heading = heading % 360;
	if (heading < 90 || heading > 270) {
		tmpDist = .00005;
	}
	midPoint = middlePoint(points[0].lat(), points[0].lng(), points[1].lat(), points[1].lng() + tmpDist );	
	
	var mapLabel = new MapLabel({
		text: dest_ft + "'",
		position: midPoint,
		map: map,
		fontSize: 12,
		align: 'center',
		strokeColor: '#303030',
		fontColor: '#FFFFFF',
		strokeWeight: 8,
		zIndex: 9999
	});
	mapLabels.push( mapLabel );
	
	var html = ""+
		"<div class='distanceTooltip'>"+
		addCommas(dest_ft)+" ft<br>"+
		addCommas(dest_yard)+" yards<br></div>";
	
	return html;
}


function polylineHover(line, location){	
	$(".distanceTooltip").remove();
	$("#map").append(line.distanceTooltip);
	var latlng = location;
	var x = overlay.getProjection().fromLatLngToContainerPixel(latlng).x;
	var y = overlay.getProjection().fromLatLngToContainerPixel(latlng).y;
	x += 15;
	$(".distanceTooltip").css('top',y).css('left',x).css('visibility','visible');
}


function placeLabel(index){
	if(areacontainer_toggle[index] == 'HIDE_PINS' || areacontainer_toggle[index] == 'HIDE_NONE' /* || id!=''*/){
		/*var html = "<div class='polygon-label' id='polygon-label-"+index+"'>"+areacontainer_labels[index]+"</div>";
		//$("#map").append(html);
		var latlng = getPolygonCenter(index);
		if(!(isNaN(latlng.lat()))){		
			var x = overlay.getProjection().fromLatLngToContainerPixel(latlng).x;
			var y = overlay.getProjection().fromLatLngToContainerPixel(latlng).y;
			y = y + 6;
			$("#polygon-label-"+index).css('top',y).css('left',x).css('visibility','visible');
		}
		*/
	}
}


function placeMarker(location, number, index) {
	if(areacontainer_types[index] == 'ADD'){	
		var icon = new google.maps.MarkerImage('img/pin.png',
				new google.maps.Size(15, 27),
				new google.maps.Point(0,0),
				new google.maps.Point(7, 27)
			);
	}else{
		var icon = new google.maps.MarkerImage('img/pin-red.png',
				new google.maps.Size(15, 27),
				new google.maps.Point(0,0),
				new google.maps.Point(7, 27)
			);
	}
	
	var shadow = new google.maps.MarkerImage('img/pin-shadow.png',
		      // The shadow image is larger in the horizontal dimension
		      // while the position and offset are the same as for the main image.
		      new google.maps.Size(25, 25),
		      new google.maps.Point(0,0),
		      new google.maps.Point(4, 33));
	
	var marker = new google.maps.Marker({
        position: location,
        map: map,
        shadow: shadow,
        icon: icon,
        draggable: false,
        index: index,
        number: number		
    });
    var f = function (index, number) {
        return function () {
            areacontainer[index][number] = marker.position;
            areacontainer_current = index;
            display();
            $(".context-menu").css('visibility','hidden');
        }
    };
    var f2 = function (index) {
    	return function() {
    		areacontainer_current = index;
    		display();
    		$(".context-menu").css('visibility','hidden');
    	}
    } 
    
    if(!(readonly)){
    	marker.setOptions({
    		draggable: true,
			
    	});
    	
    	google.maps.event.addListener(marker, 'dragend', f(index, number));
    	google.maps.event.addListener(marker, 'click', f2(index));
	
    
    	google.maps.event.addListener(marker, 'rightclick', function(event){
    		markerMenu(this, event);
    	});
    
    }
    
    return marker;
}

function deleteLastPoint(index) {
	if( !areacontainer[index] )
		return;

    if( areacontainer[index].length > 0){ 
    	areacontainer[index].length--;
    	areacontainer_labels[index].length--;
    	areacontainer_types[index].length--;
    	areacontainer_toggle[index].length--;
    }
    display();
    return false;
}


function deletePoint(index, number){
	areacontainer[index].splice(number,1);
	//areacontainer_labels[index].splice(number,1);
	//areacontainer_types[index].splice(number,1);
	display();
}


function clearAllPoints() {
	
	$("#delete-all-dialog").dialog({
	      buttons : {
	        "Confirm" : function() {
	        	areacontainer = new Array(0);
	        	areacontainer_labels = new Array(0);
	        	areacontainer_types = new Array(0);
	        	areacontainer_toggle = new Array(0);
	            //div_totalareas.style.visibility = 'hidden';
	            display();
	            //kmlcoordinates = "";
	            //div_kmloutput.innerHTML = "";
	            areaMarkers = new Array(0);
	            areaPath = new Array(0);
	            areaPath2 = new Array(0);
	            polygon = new Array(0);
	            //var points = new Array(0);
	            //areacontainer.push(points); 
	            areacontainer_current = null;
	            deleteSearchMarker();
				
				removeAllPanels();
				
	        	$(this).dialog("close");
				calculateSystemSize();
	        },
	        "Cancel" : function() {
	          $(this).dialog("close");
	        }
	      }
	    });

	    $("#delete-all-dialog").dialog("open");

	    $('.ui-dialog :button').blur();
	    
	return false;
		
}

function setPanelType()
{
	var type = document.getElementById('panel_type').value;
	if ( type )
	{
		//out.println("<option class='dropdown-choice' value='general,300,39,66'>Generic Panel 300 Watt (39&quot; x 66&quot;)</option>");
	}
}

function createNewArea() {
    points = new Array(0);
    areacontainer.push(points);
    areacontainer_current = areacontainer.length - 1;
    areacontainer_labels.push('Array '+areacontainer.length);
    areacontainer_types.push('ADD');
    areacontainer_toggle.push('HIDE_NONE');
    //console.log(areacontainer.length);
    //$("#calculations").append(calculationHTML(areacontainer_current));
    //div_totalareas.style.visibility = 'visible';
    
	if ( areacontainer.length > 0 )
		display();
    //kmlcoordinates = "";
    //div_kmloutput.innerHTML = ""
    return false;
}

  var totalPanels = 0;
//  var boxes = new google.maps.MVCArray();


       function convertPoint(latLng, map) { 
         var 
topRight=map.getProjection().fromLatLngToPoint(map.getBounds().getNorthEast()); 
         var 
bottomLeft=map.getProjection().fromLatLngToPoint(map.getBounds().getSouthWest()); 
         var scale=Math.pow(2,map.getZoom()); 
         var worldPoint=map.getProjection().fromLatLngToPoint(latLng); 
         return new google.maps.Point((worldPoint.x- 
bottomLeft.x)*scale,(worldPoint.y-topRight.y)*scale); 
       } 


	   
	   
  function renderPanels2(mapCanvas, polygog) {
  }
  
  
  function createPanels(mapCanvas)
  {
  }
  

  function inchToPx(inch, inchesPerPx) {
    var powBase;
    return inch * inchesPerPx / Math.pow(2, map.getZoom())
}

function avg(arr) {
    var sum, avg = 0;
    return arr.length && (avg = (sum = arr.reduce((function(a, b) {
        return a + b
    }))) / arr.length), avg
}


  function getPixelsPerInch(metersPerPx) {
    let pixelPerMeter, pixelsPerInch;
    return .0254 * (1 / metersPerPx)
  }

  

  
  function renderPanels2(mapCanvas, polygonxxxx) {
  }

  function selectPanel(panel)
  {
  }



function createPolygonFromRectangle(rectangle) {
    var map = rectangle.getMap();
  
    var coords = [
      { lat: rectangle.getBounds().getNorthEast().lat(), lng: rectangle.getBounds().getNorthEast().lng() },
      { lat: rectangle.getBounds().getNorthEast().lat(), lng: rectangle.getBounds().getSouthWest().lng() },
      { lat: rectangle.getBounds().getSouthWest().lat(), lng: rectangle.getBounds().getSouthWest().lng() },
      { lat: rectangle.getBounds().getSouthWest().lat(), lng: rectangle.getBounds().getNorthEast().lng() }
    ];

    // Construct the polygon.
    var rectPoly = new google.maps.Polygon({
        path: coords,
		draggable: true
    });
    var properties = ["strokeColor","strokeOpacity","strokeWeight","fillOpacity","fillColor"];
    //inherit rectangle properties 
    var options = {};
    properties.forEach(function(property) {
        if (rectangle.hasOwnProperty(property)) {
            options[property] = rectangle[property];
        }
    });
    rectPoly.setOptions(options);

    rectangle.setMap(null);
    rectPoly.setMap(map);
    return rectPoly;
}

function getCenterPoint(poly)
{
    var lowx,
        highx,
        lowy,
        highy,
        lats = [],
        lngs = [],
        vertices = poly.getPath();

    for(var i=0; i<vertices.length; i++) {
      lngs.push(vertices.getAt(i).lng());
      lats.push(vertices.getAt(i).lat());
    }

    lats.sort();
    lngs.sort();
    lowx = lats[0];
    highx = lats[vertices.length - 1];
    lowy = lngs[0];
    highy = lngs[vertices.length - 1];
    center_x = lowx + ((highx-lowx) / 2);
    center_y = lowy + ((highy - lowy) / 2);
    return (new google.maps.LatLng(center_x, center_y));
}

function rotatePoint(point, origin, angle) {
    var angleRad = angle * Math.PI / 180.0;
    return {
        x: Math.cos(angleRad) * (point.x - origin.x) - Math.sin(angleRad) * (point.y - origin.y) + origin.x,
        y: Math.sin(angleRad) * (point.x - origin.x) + Math.cos(angleRad) * (point.y - origin.y) + origin.y
    };
}

function hidePins()
{
	areacontainer_toggle[areacontainer_current]='HIDE_PINS';
	$('.ui-state-active').removeClass('ui-state-active');
	$('#radio1').addClass('ui-state-active');
	display();
}
function hideLabels()
{
	areacontainer_toggle[areacontainer_current]='HIDE_LABELS';
	$('.ui-state-active').removeClass('ui-state-active');
	$('#radio2').addClass('ui-state-active');
	display();
}
function hideBoth()
{
	areacontainer_toggle[areacontainer_current]='HIDE_BOTH';
	$('#radio3').addClass('ui-state-active');
	display();
}
function hideNone()
{
	areacontainer_toggle[areacontainer_current]='HIDE_NONE';
	$('#radio4').addClass('ui-state-active');
	display();
}


function displayCalculations(index, perimeter_m, perimeter_ft, area_m, area_km, area_acres, area_hectares, area_ft, area_snm, perimeter_yard, area_yard){
	
	var pitch = ( areacontainer[areacontainer_current]['pitch'] ? areacontainer[areacontainer_current]['pitch'] : 0 );
	var azimuth = ( areacontainer[areacontainer_current]['angle'] ? areacontainer[areacontainer_current]['angle'] : 0 );
	var panelWatts = ( areacontainer[areacontainer_current]['panelWatts'] ? areacontainer[areacontainer_current]['panelWatts'] : 0 );
	var panel_cnt = ( areacontainer[areacontainer_current]['panel_cnt'] ? areacontainer[areacontainer_current]['panel_cnt'] : 0 );
	
	
	var width = ( areacontainer[areacontainer_current]['panelWidth'] ? areacontainer[areacontainer_current]['panelWidth'] : 0 );
	var height = ( areacontainer[areacontainer_current]['panelHeight'] ? areacontainer[areacontainer_current]['panelHeight'] : 0 );
	
	var html = "" +
			"<div class='title'><a href='#' style='width:100%' onclick='setActiveArea("+index+")'>"+areacontainer_labels[index]+"</a></div>" +
			"<div id='overlay"+index+"' class='overlay'>" +
				
				"<div class='content'>" +

				
					"<table>" +
					"<thead><tr><td>Area</td><td>Perimeter</td></tr></thead>" +
					"<tbody>" +
					"<tr><td>"+addCommas(parseFloat(area_ft).toFixed(2))+" feet&sup2;</td><td>"+addCommas(parseFloat(perimeter_ft).toFixed(2))+" feet</td></tr>" +
					"<tr><td>"+addCommas(parseFloat(area_m).toFixed(2))+" m&sup2;</td><td>"+addCommas(parseFloat(perimeter_m).toFixed(2))+" m</td></tr>" +
					
					"</tbody>" +
					"</table>"+
					
					"<div class='button-actions'>" +					
						(readonly ? "" : "<button onclick='return deleteArea("+index+")' >Delete Array</button>") +
						(readonly ? "" : "<button onclick='return deleteLastPoint("+index+");'>Delete Last Point</button>") +
						(readonly ? "" : "<button onclick='return setAreaLabelDialog("+index+")' >Set Label</button>") +
						"<div style='height:40px' class='clear'></div>"+
						'<input type="radio" id="radio1" onclick="hidePins()" name="radio" value="HIDE_PINS" class="ui-helper-hidden-accessible"><label for="radio1" aria-pressed="false" class="ui-button ui-widget ui-state-default ui-button-text-only ui-corner-left" role="button" aria-disabled="false"><span class="ui-button-text">Hide Pins</span></label>' +
						'<input type="radio" id="radio2" onclick="hideLabels()" name="radio" value="HIDE_LABELS" class="ui-helper-hidden-accessible"><label for="radio2" aria-pressed="false" class="ui-button ui-widget ui-state-default ui-button-text-only" role="button" aria-disabled="false"><span class="ui-button-text">Hide Labels</span></label>' +
						'<input type="radio" id="radio3" onclick="hideBoth()" name="radio" value="HIDE_BOTH" class="ui-helper-hidden-accessible"><label for="radio3" aria-pressed="false" class="ui-button ui-widget ui-state-default ui-button-text-only" role="button" aria-disabled="false"><span class="ui-button-text">Hide Both</span></label>' +
						'<input type="radio" id="radio4" onclick="hideNone()" name="radio" value="HIDE_NONE" checked="checked" class="ui-helper-hidden-accessible"><label for="radio4" class="ui-state-active ui-button ui-widget ui-state-default ui-button-text-only ui-corner-right" aria-pressed="true" role="button" aria-disabled="false"><span class="ui-button-text">Hide None</span></label>' +
											
					"</div>" +
				"</div>" +
			"</div>";
	$("#calculations").append(html);
}

function displayCalculationTotals(perimeter_m, perimeter_ft, area_m, area_km, area_acres, area_hectares, area_ft, area_snm, perimeter_yard, area_yard){
		
	var html = "" +
		"<div class='title'><a href='#'>Totals:</a></div>" +
		"<div class='total'>" +
		"<div class='content'>" +
		"<table>" +
		"<thead><tr><td>Area</td><td>Perimeter</td></tr></thead>" +
		"<tbody>" +
		"<tr><td>"+addCommas(parseFloat(area_ft).toFixed(2))+" feet&sup2;</td><td>"+addCommas(parseFloat(perimeter_ft).toFixed(2))+" feet</td></tr>" +
		"<tr><td>"+addCommas(parseFloat(perimeter_m).toFixed(2))+" m</td><td>"+addCommas(parseFloat(area_m).toFixed(2))+" m&sup2;</td><td></td></tr>" +
		"</tbody>" +
		"</table>"+
		"</div>" +
	"</div>";
	$("#totals").append(html);
}


function setAreaLabelDialog(index){
	
	$("#setAreaLabel-dialog #label").val(areacontainer_labels[index]);
	
	$("#setAreaLabel-dialog").dialog({
	      buttons : {
	        "Set" : function() {
	        		        		        	
	        	var label = $("#setAreaLabel-dialog #label").val();
	        	
	        	if(label == ''){
	        		alert('Please input a label');
	        		return;
	        	}
	        	
	        	areacontainer_labels[index] = label
	        	
	        	display();
	        	$(this).dialog("close");
	        },
	        "Cancel" : function() {
	          $(this).dialog("close");
	        }
	      },
			open: function() {
			    $("#setAreaLabel-dialog").keypress(function(e) {
			      if (e.keyCode == $.ui.keyCode.ENTER) {
			        $(this).parent().find("button:eq(0)").trigger("click");
			      }
			    });
			  }
	    });

	    $("#setAreaLabel-dialog").dialog("open");
	    
	    $('.ui-dialog :button').blur();
	    
	return false;
}



function setLineLengthDialog(index, number){
	
	var path = areaPath2[index][number].getPath();
	var origin = path.getAt(0);
	var dest = path.getAt(1);
	var p1 = new LatLon(origin.lat(), origin.lng()); 
	var p2 = new LatLon(dest.lat(), dest.lng()); 
	
	var km = p1.distanceTo(p2);
	
	var html = "<div>"+
	"<b>Current Length:</b><br>"+
	addCommas(parseFloat(km/0.0003048).toFixed(2))+" feet<br>"+
	addCommas(parseFloat(km/0.0009144).toFixed(2))+" yards<br>"+
	addCommas(parseFloat(km/0.001).toFixed(2))+" meters<br>"+
	"</div>";
	
	$("#oldLength").html(html);
	
	
	$("#setLineLength-dialog").dialog({
	      buttons : {
	        "Set" : function() {
	        		        		        	
	        	var length = $("#setLineLength-dialog #length").val();
	        	var units = $("#setLineLength-dialog #units").val();
	        	
	        	if(length == ''){
	        		alert('Please input a length');
	        		return;
	        	}
	        	setLineLength(index, number, length, units);	        	
	        	display();
	        	$(this).dialog("close");
	        },
	        "Cancel" : function() {
	          $(this).dialog("close");
	        }
	      },
		open: function() {
		    $("#setLineLength-dialog").keypress(function(e) {
		      if (e.keyCode == $.ui.keyCode.ENTER) {
		        $(this).parent().find("button:eq(0)").trigger("click");
		      }
		    });
		  }

	    });

	    $("#setLineLength-dialog").dialog("open");
	    
	    $('.ui-dialog :button').blur();
	    
	return false;
}


function setLineLength(index, number, length, units){
		
	var path = areaPath2[index][number].getPath();
	
	var origin = path.getAt(0);
	var dest = path.getAt(1);
	
	var p1 = new LatLon(origin.lat(), origin.lng()); 
	var p2 = new LatLon(dest.lat(), dest.lng()); 
	var bearing = p1.bearingTo(p2); 
	
	var conv = 1;
	if(units=='meters')
		conv = '.001';
	if(units=='feet')
		conv = '0.0003048';
	if(units=='yards')
		conv = '0.0009144';
	if(units=='kilometers')
		conv = 1;
	if(units=='miles')
		conv = '1.60934';
	
	var distance = length * conv;
	
	var newdest = p1.destinationPoint(bearing, distance);
	
	var newdestLatLng = new google.maps.LatLng(newdest.lat(), newdest.lon());	
	
	
	if(areacontainer[index][number+1] == undefined){
		var next = 0;
	}else{
		var next = number+1;
	}
	
	areacontainer[index][next] = newdestLatLng;
	
	/*
	console.log(origin);
	console.log(dest);
	console.log(distance);
	console.log(bearing);
	console.log(newdestLatLng);
	console.log(areacontainer[index][next]);
	*/
	
	return;
	
}


function deleteArea(index){
	
	$("#delete-dialog").dialog({
	      buttons : {
	        "Confirm" : function() {
	        	areacontainer.splice(index,1);
	        	areacontainer_labels.splice(index,1);
	        	areacontainer_types.splice(index,1);
	        	areacontainer_toggle.splice(index,1);

				var boxes = boxSet[index];
				//Delete old boxes.
				if ( boxes !== null && boxes !== undefined )
				{
					for ( var i = 0; i < boxes.length; ++i) {
					  boxes[i].setMap(null);
					  delete boxes[i];
					}
				}

				boxSet.splice(index,1);
	        	if(areacontainer.length == 0){
	        		areacontainer_current = null;
	        	}else{
	        		areacontainer_current = areacontainer.length - 1;
	        	}
	        	display();
	        	$(this).dialog("close");
				
				calculateSystemSize();
	        },
	        "Cancel" : function() {
	          $(this).dialog("close");
	        }
	      }
	    });

	    $("#delete-dialog").dialog("open");
	    
	    $('.ui-dialog :button').blur();
	    
	return false;
}

function setActiveArea(index){
	areacontainer_current = index;
	
	if ( areacontainer.length > 0 )
	{
		var polygonX = areacontainer[areacontainer_current];

		document.getElementById('angelPanels').value = polygonX['angle'];
		document.getElementById('roofPitch').value   = polygonX['pitch'];

		document.getElementById('panelWidth').value = polygonX['panelWidth'];
		document.getElementById('panelHeight').value = polygonX['panelHeight'];

		document.getElementById('panelWatts').value = polygonX['panelWatts'];
			
		display();
				
		
	}
	return true;
}

function searchAddress(){
	$('#loading').show();	
	var params = "";
	params += $("#search-form").serialize();	
	if($('#address').val() != ''){		
		var address = $('#address').val();		
		geocoder.geocode( { 'address': address}, function(results, status) {
			var location = '';		
			  if(status == google.maps.GeocoderStatus.OK) {			
				location = results[0].geometry.location;				
				map.setCenter(location);
				
				var resultBounds = new google.maps.LatLngBounds(
				    results[0].geometry.viewport.getSouthWest(), 
				    results[0].geometry.viewport.getNorthEast()
				);

				map.fitBounds(resultBounds);

				placeSearchMarker(location);

				map.setZoom(20);				 
			  }
			  $('#loading').hide();
		});					
	} 		
	return false;
}

function saveMapDialog(){
	
	$("#save-dialog").dialog({
		  width:400,
	      buttons : {
	        "Send" : function() {
	        	if($('#save-form #name').val() == '' || $('#save-form #email').val() == ''){
	        		alert('Please fill out all required fields');
	        		return;
	        	}
	        	saveMap();
	        	$(this).dialog("close");
	        },
	        "Cancel" : function() {
	          $(this).dialog("close");
	        }
	      },
			open: function() {
			    $("#save-dialog").keypress(function(e) {
			      if (e.keyCode == $.ui.keyCode.ENTER) {
			        $(this).parent().find("button:eq(0)").trigger("click");
			      }
			    });
			  }
	    });

	    $("#save-dialog").dialog("open");
	    
	    $('.ui-dialog :button').blur();
	    
	    return false;
}

function saveMap(){
	
	if(areacontainer.length > 0){
		for(var i=0; i<areacontainer.length; i++){
			if(areacontainer[i].length > 0){
				var points = new Array(0);
				for(var j=0; j<areacontainer[i].length; j++){
					var point = areacontainer[i][j].lat()+','+areacontainer[i][j].lng();
					points.push(point);			
				}
				var temp = points.join('~');
				$('#save-form #hidden').append("<input type='hidden' name='overlay[]' value='"+temp+"' />");
				$('#save-form #hidden').append("<input type='hidden' name='label[]' value='"+areacontainer_labels[i]+"' />");
				$('#save-form #hidden').append("<input type='hidden' name='type[]' value='"+areacontainer_types[i]+"' />");
			}
		}
		/*
		for(var i=0; i<areacontainer_labels.length; i++){
			$('#save-form #hidden').append("<input type='hidden' name='label[]' value='"+areacontainer_labels[i]+"' />");
		}
		for(var i=0; i<areacontainer_types.length; i++){
			$('#save-form #hidden').append("<input type='hidden' name='type[]' value='"+areacontainer_types[i]+"' />");
		}
		*/
		var params = $('#save-form').serialize();
		var msg = eval($.ajax({async:false, url:'ajax/save.php?', cache:false, type:'POST', data: params}).responseText);
		$('#save-form #hidden').html('');
	}else{
		var msg = Array(0);
		msg[0] = false;
		msg[1] = "Your map has no overlays. Please add at least one."
	}
	
	alert(msg[1]);
	
	return false;
}


function shapeDialog(){
	
	$("#shape-dialog").dialog({
		 width: 300,
	      buttons : {
	        "Add Shape" : function() {
	        	var type = $("#type").val();
	        	if(type=='rectangle'){
	        		var units = $("#rectangle #units").val();
		        	var length1 = $("#rectangle #side1").val();
		        	var length2 = $("#rectangle #side2").val();
		        	if(length1 == '' || length2 == ''){
		        		alert('Please fill out all fields');
		        		return;
		        	}		        		
		        	addRect(units, length1, length2);
	        	}
	        	else if(type=='triangle'){
	        		var units = $("#triangle #units").val();
		        	var length1 = $("#triangle #side1").val();
		        	var length2 = $("#triangle #side2").val();
		        	var angle1 = $("#triangle #angle1").val();
		        	if(length1 == '' || length2 == '' || angle1 == ''){
		        		alert('Please fill out all fields');
		        		return;
		        	}
		        	if(parseFloat(angle1) > 90){
		        		alert('Acute angle must be less than 90 degrees');
		        		return;
		        	}
		        	addTri(units, length1, length2, angle1);
	        	}
	        	else if(type=='circle'){
	        		var units = $("#circle #units").val();
		        	var length1 = $("#circle #side1").val();
		        	if(length1 == ''){
		        		alert('Please fill out all fields');
		        		return;
		        	}
		        	addCirc(units, length1);
	        	}
	        	else if(type=='semicircle'){
	        		var units = $("#semicircle #units").val();
		        	var length1 = $("#semicircle #side1").val();
		        	if(length1 == ''){
		        		alert('Please fill out all fields');
		        		return;
		        	}
		        	addSemiCirc(units, length1);
	        	}
	        	        	
	        	
	        	$(this).dialog("close");
	        },
	        "Cancel" : function() {
	          $(this).dialog("close");
	        }
	      },
			open: function() {
			    $("#shape-dialog").keypress(function(e) {
			      if (e.keyCode == $.ui.keyCode.ENTER) {
			        $(this).parent().find("button:eq(0)").trigger("click");
			      }
			    });
			  }
	    });

	    $("#shape-dialog").dialog("open");
	    
	    $('.ui-dialog :button').blur();
	    
	    return false;
}


function addRect(units, length1, length2){
	createNewArea();
	var conv = 1;
	if(units=='meters')
		conv = '.001';
	if(units=='feet')
		conv = '0.0003048';
	if(units=='yards')
		conv = '0.0009144';
	if(units=='kilometers')
		conv = 1;
	if(units=='miles')
		conv = '1.60934';
	var length1_km = length1 * conv;
	var length2_km = length2 * conv;
	var point1 = map.getCenter();
	var p1 = new LatLon(point1.lat(), point1.lng());                                                      
	var p2 = p1.destinationPoint(0,length1_km);          // in km
	var p3 = p2.destinationPoint(90,length2_km);
	var p4 = p3.destinationPoint(180,length1_km);		
	
	var point2 = new google.maps.LatLng(p2.lat(), p2.lon());
	var point3 = new google.maps.LatLng(p3.lat(), p3.lon());
	var point4 = new google.maps.LatLng(p4.lat(), p4.lon());
	areacontainer[areacontainer_current].push(point1);
	areacontainer[areacontainer_current].push(point2);
	areacontainer[areacontainer_current].push(point3);
	areacontainer[areacontainer_current].push(point4);
	display();
}

function addTri(units, length1, length2, angle1){
	createNewArea();
	var conv = 1;
	if(units=='meters')
		conv = '.001';
	if(units=='feet')
		conv = '0.0003048';
	if(units=='yards')
		conv = '0.0009144';
	if(units=='kilometers')
		conv = 1;
	if(units=='miles')
		conv = '1.60934';
	var length1_km = length1 * conv;
	var length2_km = length2 * conv;
	var point1 = map.getCenter();
	var p1 = new LatLon(point1.lat(), point1.lng());
	var p2 = p1.destinationPoint(90,length1_km);
	var p3 = p1.destinationPoint(90-parseFloat(angle1),length2_km);
	var point2 = new google.maps.LatLng(p2.lat(), p2.lon());
	var point3 = new google.maps.LatLng(p3.lat(), p3.lon());
	areacontainer[areacontainer_current].push(point1);
	areacontainer[areacontainer_current].push(point2);
	areacontainer[areacontainer_current].push(point3);
	display();
}

function addCirc(units, length1){
	createNewArea();
	var conv = 1;
	if(units=='meters')
		conv = '.001';
	if(units=='feet')
		conv = '0.0003048';
	if(units=='yards')
		conv = '0.0009144';
	if(units=='kilometers')
		conv = 1;
	if(units=='miles')
		conv = '1.60934';
	var length1_km = length1 * conv;
	var radius = length1_km * .000157;
	var d = radius;
	var point1 = map.getCenter();
	
	with(Math){
		var lat1 = (PI/180)* point1.lat(); // radians
		var lng1 = (PI/180)* point1.lng(); // radians	
	
		var circlePoints = Array();
		var bearing = 0;
		
		for (var a = bearing-360 ; a < bearing+1 ; a=a+2 ) {
			var tc = (PI/180)*a;
			var y = asin(sin(lat1)*cos(d)+cos(lat1)*sin(d)*cos(tc));
			var dlng = atan2(sin(tc)*sin(d)*cos(lat1),cos(d)-sin(lat1)*sin(y));
			var x = ((lng1-dlng+PI) % (2*PI)) - PI ; // MOD function
			var point = new google.maps.LatLng(parseFloat(y*(180/PI)),parseFloat(x*(180/PI)));
			circlePoints.push(point);
		}
	}
	
	areacontainer[areacontainer_current] = circlePoints;

	display();
	
}

function addSemiCirc(units, length1){
	createNewArea();
	var conv = 1;
	if(units=='meters')
		conv = '.001';
	if(units=='feet')
		conv = '0.0003048';
	if(units=='yards')
		conv = '0.0009144';
	if(units=='kilometers')
		conv = 1;
	if(units=='miles')
		conv = '1.60934';
	var length1_km = length1 * conv;
	var radius = length1_km * .000157;
	var d = radius;
	var point1 = map.getCenter();
	
	with(Math){
		var lat1 = (PI/180)* point1.lat(); // radians
		var lng1 = (PI/180)* point1.lng(); // radians	
	
		var circlePoints = Array();
		var bearing = 0;
		
		for (var a = bearing-180 ; a < bearing+1 ; a=a+2 ) {
			var tc = (PI/180)*a;
			var y = asin(sin(lat1)*cos(d)+cos(lat1)*sin(d)*cos(tc));
			var dlng = atan2(sin(tc)*sin(d)*cos(lat1),cos(d)-sin(lat1)*sin(y));
			var x = ((lng1-dlng+PI) % (2*PI)) - PI ; // MOD function
			var point = new google.maps.LatLng(parseFloat(y*(180/PI)),parseFloat(x*(180/PI)));
			circlePoints.push(point);
		}
	}
	
	areacontainer[areacontainer_current] = circlePoints;

	display();
	
}


function setReadonly(id){
	
	$("#search-form").hide();
	//google.maps.event.clearInstanceListeners(map);

	var params = 'id='+id;
	$.ajax({async:true, url:'ajax/populate.php?', dataType: 'json', cache:false, type:'POST', data: params, success: function(data){ 
		var result = convertToPoints(data.coordinates); 
		areacontainer = result; 
		areacontainer_current = 0;
		areacontainer_labels = data.labels;
		areacontainer_types = data.types;
		
		for(var i = 0; i<areacontainer.length; i++){
			areacontainer_toggle[i] = 'HIDE_NONE';
		}
		
		display(true);
		
		var bounds = new google.maps.LatLngBounds(); 
		for(var i=0; i<areaMarkers.length; i++){
			bounds.extend(areaMarkers[i].getPosition());
		}
		map.fitBounds(bounds);

		display(true);
		
		}
	});
	
	
}


function getPolygonCenter(index){
	
	var x_total = 0;
	var y_total = 0;

	
	for(var i=0; i<areacontainer[index].length; i++){
        		     		
		var tempx = overlay.getProjection().fromLatLngToContainerPixel(areacontainer[index][i]).x;
		x_total = x_total + tempx;
		var tempy = overlay.getProjection().fromLatLngToContainerPixel(areacontainer[index][i]).y;
		y_total = y_total + tempy;
				
	}
	
	x_total = x_total / areacontainer[index].length;
	y_total = y_total / areacontainer[index].length;
	
	var tempPoint = new google.maps.Point(x_total, y_total);
	var latlng = overlay.getProjection().fromContainerPixelToLatLng(tempPoint);
		
	return latlng;
	
}


function convertToPoints(array){
	
	for(var i=0; i<array.length; i++){
		for(var j=0; j<array[i].length; j++){
			var temp = array[i][j].split(',');
			var lat = temp[0];
			var lng = temp[1];
			array[i][j] = new google.maps.LatLng(lat, lng);
		}
	}
	
	return array;
}






function addSelectedPanel(panel, section) {
    null == panel || -1 == selectedPanels.indexOf(panel) ? (null != panel && panel.setOptions({
        fillColor: "red"
    }), selectedPanels.push(panel), null != section && setSelectedSection(section)) : deselectPanel(panel)
}

function deletePanel(p) {
    var index = selectedSection.boxes.indexOf(p); - 1 !== index && selectedSection.boxes.splice(index, 1), p.setMap(null), delete p;
    let pIndex = selectedPanels.indexOf(p);
    selectedPanels.splice(pIndex, 1), layoutChanged = !0, -1 === selectedSection.deletedPanels.indexOf(p.panelIndex) && selectedSection.deletedPanels.push(p.panelIndex)
}

function deselectPanel(panel, section) {
    if (null == panel || -1 === selectedPanels.indexOf(panel)) return;
    panel.setOptions({
        fillColor: "blue"
    });
    let index = selectedPanels.indexOf(panel); - 1 !== index && selectedPanels.splice(index, 1), null != section && setSelectedSection(section)
}

function setSelectedPanel(panel, section) {
    null != panel && -1 != selectedPanels.indexOf(panel) || (null != panel && panel.setOptions({
        fillColor: "red"
    }), selectedPanels.forEach(p => p.setOptions({
        fillColor: "blue"
    })), selectedPanels = null === panel ? [] : [panel], null != section && setSelectedSection(section))
}

function placeAnchor(location, index){
	
	//var icon = "img/mini-marker.png";
	var icon = new google.maps.MarkerImage("img/mini-marker.png",
			new google.maps.Size(16, 16),
			new google.maps.Point(0,0),
			new google.maps.Point(6, 6)
		);
	
	if(readonly){
		draggable = false;
	}else{
		draggable = false;//true;
	}
	
	var marker = new google.maps.Marker({
        position: location,
        map: map,
        //shadow: shadow,
        icon: icon,
        draggable: draggable,
        oldposition: location,
        index: index
    });
	
	var f = function (index) {
        return function () {
            //areacontainer[index][number] = marker.position;
            //areacontainer_current = index;
        	//var oldlat = marker.oldposition.lat();
        	//var newlat = marker.position.lat();
        	//console.log(oldlat);
        	//console.log(newlat);
        	var oldx = overlay.getProjection().fromLatLngToContainerPixel(marker.oldposition).x;
        	var newx = overlay.getProjection().fromLatLngToContainerPixel(marker.position).x;
        	var diffx = newx - oldx;
        	
        	var oldy = overlay.getProjection().fromLatLngToContainerPixel(marker.oldposition).y;
        	var newy = overlay.getProjection().fromLatLngToContainerPixel(marker.position).y;
        	var diffy = newy - oldy;
        	//overlay.getProjection().fromContainerPixelToLatLng()
        	for(var i =0; i<areacontainer[index].length; i++){
        		
        		//Point(x:number, y:number)
        		
        		var tempx = overlay.getProjection().fromLatLngToContainerPixel(areacontainer[index][i]).x;
        		tempx = tempx + diffx;
        		var tempy = overlay.getProjection().fromLatLngToContainerPixel(areacontainer[index][i]).y;
        		tempy = tempy + diffy;
        		
        		var tempPoint = new google.maps.Point(tempx, tempy);
        		areacontainer[index][i] = overlay.getProjection().fromContainerPixelToLatLng(tempPoint);
        	}
        	areacontainer_current = index;        	
            display();
            $(".context-menu").css('visibility','hidden');
        }
    };
    
    
    var f2 = function (index, marker ) {
		selectedBox = marker;
        return function () {
        	areacontainer_current = index;
            display();
            $(".context-menu").css('visibility','hidden');
        }
    };
    
    if(!(readonly)){
    	google.maps.event.addListener(marker, 'dragend', f(index));
    	//google.maps.event.addListener(marker, 'click', f2(index, location, 10));
    	
    	google.maps.event.addListener(marker, 'rightclick', function(event){
        	polygonMenu(this,event);	            	
			selectedBox = marker;
        });
    	
    }
    //ccc
    google.maps.event.addListener(marker, 'click', f2(index, marker));
    
	return marker;
}



function placeRotator(location, index){
		
	var icon = "img/rotate.png";
	
	if(readonly){
		draggable = false;
	}else{
		draggable = true;
	}
	
	var anchor = location;
	
	var polygon_top = polygon[index].getBounds().getNorthEast().lat();
	var p1 = new LatLon(polygon_top,location.lng());
	var p2 = new LatLon(location.lat(), location.lng());
	var result = p1.midpointTo(p2);
	var location = new google.maps.LatLng(result.lat(), result.lon());
		
	var marker = new google.maps.Marker({
        position: location,
        map: map,
        icon: icon,
        draggable: draggable,
        oldposition: location,
        index: index,
        anchor: anchor
    });
	
	var line = new google.maps.Polyline({
        path: [marker.getPosition(), anchor],
        map: map,
        strokeColor: '#ffffff',
        strokeWeight: 1
      });
	
	rotatorLines.push(line);
    
	marker.position_changed = function() {
		update_rotator_line(line, this.get('position'), this.anchor);
      }
    
    var f2 = function (index) {
        return function () {
        	areacontainer_current = index;
            display();
            $(".context-menu").css('visibility','hidden');
        }
    };
    
    if(!(readonly)){
    	google.maps.event.addListener(marker, 'dragend', function(event){
    		dragRotation(this,event);
    	});
    	//google.maps.event.addListener(marker, 'click', f2(index, location, 10));
    	
    	google.maps.event.addListener(marker, 'rightclick', function(event){
//        	polygonMenu(this,event);	            	
        });
    	google.maps.event.addListener(marker, 'click', f2(index));
		
    }
    
	return marker;
}


function update_rotator_line(line, position1, position2){
    // update the line
    line.getPath().setAt(0, position1);
    line.getPath().setAt(1, position2);
  }


function dragRotation(marker, event){
	
	areacontainer_current = marker.index;
	//console.log(marker.anchor);
	
	var initialPoint = marker.anchor;//areaAnchors[marker.index].position;
	var p1 = new LatLon(initialPoint.lat(),initialPoint.lng());
	var p2 = new LatLon(event.latLng.lat(),event.latLng.lng());
	
	var bearing = p1.finalBearingTo(p2);
	
	rotatePoly(marker.index, initialPoint, bearing)
	//renderPanels(map, null);

	index = marker.index;
	
/*	var polygon_top = polygon[index].getBounds().getNorthEast().lat();
	var po1 = new LatLon(polygon_top,location.lng());
	var po2 = new LatLon(location.lat(), location.lng());
	var result = po1.midpointTo(po2);*/

    var bounds = new google.maps.LatLngBounds()
    var location = initialPoint;// polygonCenter(polygon); //.getPolygonCenter();//getPath().forEach(function(element,index){bounds.extend(element)})
	
//	var location = bounds.getCenter();
	//new google.maps.LatLng(result.lat(), result.lon());

	var overlay = areacontainer[marker.index];
	var boxes = boxSet[marker.index];
	for ( var i = 0; i < boxes.length; ++i )
	{
		rotatePolyBox(boxes[i], location, bearing);
	}
	
	$(".context-menu").css('visibility','hidden');
}


function rotatePoly(index, pivotPoint, angle) {
	var newPath = [];
	var path = areacontainer[index];
	for (var p = 0 ; p < path.length ; p++) {
		var pt = transposePoint(path[p],pivotPoint,angle);
		newPath.push(pt);
	}
	areacontainer[index] = newPath;
	display();
	
	//renderPanels(map, null);
}


function deselectAll()
{
	for ( var i = 0;i < selectedBoxList.length; ++i )
		selectedBoxList[i].fillColor = 'white';
	selectedBoxList = [];
	selectedBox = null;
}

function rotatePolyBox(box, pivotPoint, angle) {
	var newPath = [];
	var path = box.getPath();
	for (var p = 0 ; p < path.length ; p++) {
		var pt = transposePoint(path.b[p],pivotPoint,angle);
		newPath.push(pt);
	}
	box.setPath( newPath);
	
	//renderPanels(map, null);
}

  
function transposePoint(point,pivotPoint,angle) {
	
	var tmpXY = overlay.getProjection().fromLatLngToContainerPixel(pivotPoint);
	var centerX = parseFloat(tmpXY.x); 
	var centerY = parseFloat(tmpXY.y); 
	
	var tmpXY = overlay.getProjection().fromLatLngToContainerPixel(point);
	var theX = parseFloat(tmpXY.x);
	var theY = parseFloat(tmpXY.y);
	
	angle = parseFloat(angle);
	
	with(Math){
		if (centerX == 0 && centerY == 0) {
		    var newX = theX * cos(angle.toRad()) - sin(angle.toRad()) * theY;
		    var newY = theX * sin(angle.toRad()) + cos(angle.toRad()) * theY;
		} else {
		    var newX = (theX - centerX) * cos(angle.toRad()) - (theY - centerY) * sin(angle.toRad()) + centerX;
		    var newY = (theX - centerX) * sin(angle.toRad()) + (theY - centerY) * cos(angle.toRad()) + centerY;
		}
	}
	
	var tempPoint = new google.maps.Point(newX, newY);
	var pt = overlay.getProjection().fromContainerPixelToLatLng(tempPoint); 
	return pt;
	
}


function transposePoint2(point,pivotPoint,angle) {
	
	var tmpXY = pivotPoint;
	var centerX = parseFloat(tmpXY.x); 
	var centerY = parseFloat(tmpXY.y); 
	
	var tmpXY = point;
	var theX = parseFloat(tmpXY.x);
	var theY = parseFloat(tmpXY.y);
	
	angle = parseFloat(angle);
	
	with(Math){
		if (centerX == 0 && centerY == 0) {
		    var newX = theX * cos(angle.toRad()) - sin(angle.toRad()) * theY;
		    var newY = theX * sin(angle.toRad()) + cos(angle.toRad()) * theY;
		} else {
		    var newX = (theX - centerX) * cos(angle.toRad()) - (theY - centerY) * sin(angle.toRad()) + centerX;
		    var newY = (theX - centerX) * sin(angle.toRad()) + (theY - centerY) * cos(angle.toRad()) + centerY;
		}
	}
	
	var tempPoint = new google.maps.Point(newX, newY);
	return tempPoint;
	
}

function instructionsDialog(){
	
	$("#instructions-dialog").dialog({
		  width:600,
	      buttons : {	        
	        "Close" : function() {
	          $(this).dialog("close");
	        }
	      }
	    });

	    $("#instructions-dialog").dialog("open");
	    
	    $('.ui-dialog :button').blur();
	    
	    //$(window).trigger('resize');
	    
	    return false;
}



function fileDialog(){
	
	$("#file-dialog").dialog({
		  width:400,
	      buttons : {	        
	        "Close" : function() {
	          $(this).dialog("close");
	        }
	      }
	    });

	    $("#file-dialog").dialog("open");

	    $('.ui-dialog :button').blur();

	    return false;
}



function genKML(){
	
	if(areacontainer.length > 0){
		for(var i=0; i<areacontainer.length; i++){
			if(areacontainer[i].length > 0){
				var points = new Array(0);
				for(var j=0; j<areacontainer[i].length; j++){
					var point = areacontainer[i][j].lat()+','+areacontainer[i][j].lng();
					points.push(point);			
				}
				var temp = points.join('~');
				$('#export-form').append("<input type='hidden' name='overlay[]' value='"+temp+"' />");
				$('#export-form').append("<input type='hidden' name='label[]' value='"+areacontainer_labels[i]+"' />");
				$('#export-form').append("<input type='hidden' name='type[]' value='"+areacontainer_types[i]+"' />");
			}
		}
		
		//var params = $('#save-form').serialize();
		//var msg = eval($.ajax({async:false, url:'ajax/gen_kml.php?', cache:false, type:'POST', data: params}).responseText);
		//window.location = 'ajax/gen_kml.php?'+params;
		$('#export-form').submit();
		$('#export-form').html('');
	}else{
		var msg = Array(0);
		msg[0] = false;
		msg[1] = "Your design has no arrays. Please add at least one.";
		alert(msg[1]);
	}
			
	return false;
}


function placeSearchMarker(location) {

	deleteSearchMarker();
    
	var icon = new google.maps.MarkerImage('img/pin-red.png',
		new google.maps.Size(15, 27),
		new google.maps.Point(0,0),
		new google.maps.Point(7, 27));
	
	var shadow = new google.maps.MarkerImage('img/pin-shadow.png',
    	new google.maps.Size(25, 25),
    	new google.maps.Point(0,0),
    	new google.maps.Point(4, 33));
	
	var marker = new google.maps.Marker({
        position: location,
        map: map,
        shadow: shadow,
        icon: icon,
        draggable: false

    }); 
    
    google.maps.event.addListener(marker, 'rightclick', function(event){
		searchMarkerMenu(this, event);
	});

	marker.setOptions({
    	draggable: true
    });

    /*
    if(!(readonly)){
    		
    	google.maps.event.addListener(marker, 'dragend', f(index, number));
    	google.maps.event.addListener(marker, 'click', f2(index, number));
	
    
    	google.maps.event.addListener(marker, 'rightclick', function(event){
    		markerMenu(this, event);
    	});
    
    }
    */
    
    search_marker = marker;


}

function toggleRotators( )
{
	for ( var i = 0; i < areaRotators.length; ++i )
	{
		if ( areaRotators[i].getMap() != null ) {
			areaRotators[i].setMap(null);
			rotatorLines[i].setMap(null);
		}
		else
		{
			areaRotators[i].setMap(map);
			rotatorLines[i].setMap(map);
		}
	}
}

function deleteSearchMarker(){
	if(search_marker != null){
		search_marker.setMap(null);
		search_marker = null;
	}
}